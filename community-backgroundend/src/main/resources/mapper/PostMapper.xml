<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.liu.springbootdemo.mapper.PostMapper">

    <update id="updatePost">
        UPDATE posts
        <set>
            <if test="P.title != null and P.title != ''">
                title = #{P.title},
            </if>
            <if test="P.content != null and P.content != ''">
                content = #{P.content},
            </if>
            <if test="P.categoryId != null">
                category_id = #{P.categoryId},
            </if>
            <if test="P.categoryName != null and P.categoryName != ''">
                category_name = #{P.categoryName},
            </if>
            <if test="P.summary != null and P.summary != ''">
                summary = #{P.summary},
            </if>
            <if test="P.coverImage != null and P.coverImage != ''">
                cover_image = #{P.coverImage},
            </if>
            update_time = NOW()
        </set>
        WHERE id = #{id}
    </update>


    <select id="findPostsByUserId" resultType="com.liu.springbootdemo.POJO.vo.PostSummaryVO">
        SELECT p.id,p.title,p.summary,p.cover_image,p.create_time,p.update_time,
               p.category_name,p.view_count,p.like_count,p.collect_count,p.comment_count,p.is_pinned,p.is_essence,p.status
        FROM posts p
        <where>
            p.user_id = #{userId}
            <if test="isAuthor"><!-- 如果是用户自身，只查询未删除的帖子 -->
                AND p.status != ${@com.liu.springbootdemo.common.enums.PostStatus@DELETED.getStatus()}
            </if>
            <if test="!isAuthor and !isAdmin"><!-- 如果是游客身份，只查询已发布的帖子(也可能是b站的以他人视角查看...再说) -->
                AND p.status = ${@com.liu.springbootdemo.common.enums.PostStatus@PUBLISHED.getStatus()}
            </if>
        </where>
        ORDER BY p.update_time DESC
    </select>

    <select id="getPostsByCursor" resultType = "com.liu.springbootdemo.POJO.vo.PostSummaryVO">
        SELECT p.*,u.username,u.avatar_url as userAvatarUrl
        FROM posts p
        LEFT JOIN users u ON p.user_id = u.id 
        WHERE p.status = ${@com.liu.springbootdemo.common.enums.PostStatus@PUBLISHED.getStatus()}
        <if test="cursor != null">
            AND p.id &lt; #{cursor}
        </if>
        ORDER BY p.id DESC
        LIMIT #{size}
    </select>

</mapper>